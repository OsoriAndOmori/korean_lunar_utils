name: Tag from pubspec version

on:
  push:
    branches:
      - main

permissions:
  contents: write  # tag push 하려면 필요

concurrency:
  group: tag-from-pubspec-main
  cancel-in-progress: false

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read version from pubspec.yaml
        id: ver
        run: |
          set -euo pipefail

          if [ ! -f pubspec.yaml ]; then
            echo "pubspec.yaml not found"; exit 1
          fi

          VERSION="$(grep -E '^version:\s*[0-9]+\.[0-9]+\.[0-9]+' pubspec.yaml | head -n1 | awk '{print $2}')"
          if [ -z "${VERSION}" ]; then
            echo "Could not parse version from pubspec.yaml"; exit 1
          fi

          # pub.dev 설정이 {{version}} 이므로 태그는 '1.2.3' 형태여야 함
          if ! echo "${VERSION}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Version must be x.y.z (got: ${VERSION})"; exit 1
          fi

          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected version: ${VERSION}"

      - name: Create & push tag (if not exists)
        run: |
          set -euo pipefail
          TAG="${{ steps.ver.outputs.version }}"

          git fetch --tags origin

          # 원격에 동일 태그가 이미 있으면 종료 (같은 버전 재배포 방지)
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "Tag ${TAG} already exists on origin. Skipping."
            exit 0
          fi

          git tag "${TAG}"
          git push origin "refs/tags/${TAG}"

          echo "Pushed tag: ${TAG}"
